import streamlit as st
import pandas as pd
import openpyxl

# Configurar la p√°gina
st.set_page_config(page_title="Encuesta: Descubre el Sabor de tu Canci√≥n", layout="wide")

# Diccionario de palabras y su clasificaci√≥n
palabras_clasificadas = {
    "Dulces": ["Alegre", "Vibrante", "Brillante", "Rom√°ntica", "Dulce", "Envolvente", "Festiva", "Suave", "Elevadora"],
    "√Åcido-Dulces": ["Melanc√≥lica", "Profunda", "Explosiva", "Dram√°tica", "Reflexiva", "Nost√°lgica", "Sofisticada"],
    "√Åcidas": ["Oscura", "Intensa", "Hipn√≥tica", "Ca√≥tica", "Contundente", "Triste", "Agresiva"]
}

# Lista de sabores organizados por dulzura
sabores_mermelada = {
    "Dulces": ["Mango", "Guan√°bana", "Brevas", "Remolacha", "Papayuela", "Pera Boyacense", "Durazno Criollo", "Guayaba", "Feijoa"],
    "√Åcido-Dulces": ["Tomate de √°rbol", "Ar√°ndanos", "Fresas de Subachoque", "Ruibarbo y fresas", "Pi√±a", "Mora", "Chontaduro", "Ciruela Criolla"],
    "√Åcidas": ["Frutos C√≠tricos", "Lulo", "Uchuvas", "Tamarindo", "Naranja"]
}

# Inicializar variables de sesi√≥n
if "seleccionadas" not in st.session_state:
    st.session_state["seleccionadas"] = []
if "mostrar_resultado" not in st.session_state:
    st.session_state["mostrar_resultado"] = False
if "guardar_respuesta" not in st.session_state:
    st.session_state["guardar_respuesta"] = False
if "datos_guardados" not in st.session_state:
    st.session_state["datos_guardados"] = None

# Datos del usuario
st.title("üéµ Encuesta: Descubre el Sabor de tu Canci√≥n üé∂")
st.write("Completa los siguientes campos y luego selecciona palabras que describan la canci√≥n")

nombre = st.text_input("Nombre Completo", value=st.session_state.get("nombre", ""))
correo = st.text_input("Correo Electr√≥nico", value=st.session_state.get("correo", ""))
spotify_link = st.text_input("Enlace de la canci√≥n en Spotify", value=st.session_state.get("spotify_link", ""))

st.session_state["nombre"] = nombre
st.session_state["correo"] = correo
st.session_state["spotify_link"] = spotify_link

st.write("---")

# Simulaci√≥n de selecci√≥n de palabras
st.subheader("üîπ Selecciona entre 5 y 10 palabras que describan la canci√≥n")

# Crear tres columnas
col1, col2, col3 = st.columns(3)

for categoria, lista_palabras in palabras_clasificadas.items():
    for palabra in lista_palabras:
        if categoria == "Dulces":
            col = col1
        elif categoria == "√Åcido-Dulces":
            col = col2
        else:
            col = col3

        display_text = f"‚úÖ {palabra}" if palabra in st.session_state["seleccionadas"] else palabra

        if col.button(display_text, key=palabra, help="Selecciona esta palabra"):
            if palabra not in st.session_state["seleccionadas"] and len(st.session_state["seleccionadas"]) < 10:
                st.session_state["seleccionadas"].append(palabra)
            elif palabra in st.session_state["seleccionadas"]:
                st.session_state["seleccionadas"].remove(palabra)

st.write("---")

# Evaluar selecci√≥n
if 5 <= len(st.session_state["seleccionadas"]) <= 10:
    st.subheader("‚ùì ¬øQuieres que tu sabor musical sea secreto hasta que llegue a ti?")
    
    col1, col2 = st.columns(2)
    if col1.button("üéµ Descubre tu Mermelada Musical üé∂"):
        st.session_state["mostrar_resultado"] = True
    if col2.button("üîí Guardar respuesta en secreto"):
        st.session_state["guardar_respuesta"] = True
    
    if st.session_state["mostrar_resultado"] or st.session_state["guardar_respuesta"]:
        palabras = st.session_state["seleccionadas"]
        
        # Clasificar palabras seg√∫n categor√≠as
        predominantes = palabras[:3]
        secundarias = palabras[3:7]
        
        # Determinar sabores
        sabores_seleccionados = list({sabor for categoria, sabores in sabores_mermelada.items() for palabra in predominantes + secundarias if palabra in palabras_clasificadas[categoria] for sabor in sabores})
        
        if len(sabores_seleccionados) >= 2:
            sabor_principal, sabor_secundario = sabores_seleccionados[:2]
        elif len(sabores_seleccionados) == 1:
            sabor_principal, sabor_secundario = sabores_seleccionados[0], "Sin combinaci√≥n"
        else:
            sabor_principal, sabor_secundario = "No determinado", "No determinado"
        
        # Guardar los datos
        st.session_state["datos_guardados"] = pd.DataFrame({
            "Nombre": [nombre],
            "Correo": [correo],
            "Spotify Link": [spotify_link],
            "Palabras Seleccionadas": [", ".join(st.session_state["seleccionadas"])],
            "Sabor Principal": [sabor_principal],
            "Sabor Secundario": [sabor_secundario]
        })
        
        if st.session_state["mostrar_resultado"]:
            st.subheader("üéØ Resultado")
            st.success(f"üçì **Tu mermelada ideal es:** {sabor_principal} con {sabor_secundario}")

# Bot√≥n para descargar directamente
if st.session_state["datos_guardados"] is not None:
    if st.button("‚¨áÔ∏è Descargar respuestas en Excel", key="descarga_oculta"):
        excel_file = "respuestas_encuesta.xlsx"
        st.session_state["datos_guardados"].to_excel(excel_file, index=False, engine='openpyxl')
        with open(excel_file, "rb") as file:
            st.download_button(label="Descargar Archivo", data=file, file_name=excel_file, mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet")
